#!/usr/bin/env bash
set -eo pipefail
APP="$1";
CONF="$APP_ROOT/nginx.conf"

echo "upstream $APP {" > $CONF
grep "^web=" $APP_ROOT/PS | while read line; do
  NUM=${line#*=}
  for ((i=1; i<=$NUM; i++)); do
    PORT=$(docker port $APP.web.$i 5000 | sed 's/0.0.0.0://')
    echo "server 127.0.0.1:$PORT;" >> $CONF
  done
done
echo "}" >> $CONF